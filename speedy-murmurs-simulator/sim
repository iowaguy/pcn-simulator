#!/bin/bash

LOG_DIR=logs
EXPERIMENT_LOG=${LOG_DIR}/experiment-`hostname`-`date +%m-%d-%y:%S`.out
IPCLUSTER_DIR=${HOME}/.ipython/`hostname`/
usage() {
  echo "Usage: $0 [start|stop|status]" 1>&2
  exit 1
}

stop() {
  ipcluster stop --IPClusterApp.ipython_dir=${IPCLUSTER_DIR}
  echo "ipcluster killed."

  ps -ef | grep ipyparallel | grep -v grep | awk '{print $2}' | xargs kill -9
  ps -ef | grep ipcluster | grep -v grep | awk '{print $2}' | xargs kill -9
  ps -ef | grep experiment | awk '{print $2}' | xargs kill -9
  ps -ef | grep java | awk '{print $2}' | xargs kill -9
  echo "attack killed."
  exit 0
}

status() {
  lines=$(ps -ef | grep ipcluster | grep -v grep | wc -l)
  if [ $lines -gt 0 ]; then
    echo "ipcluster is running..."
  else
    echo "ipcluster is not running..."
  fi

  lines=$(ps -ef | grep attack | grep -v grep | wc -l)
  if [ $lines -gt 0 ]; then
    echo "experiment is running..."
  fi

  exit 0
}

start() {
  ENGINES="$1"
  ipcluster start --daemonize=True -n "${ENGINES}" --ProfileDir.location="${IPCLUSTER_DIR}"
  exec tail -f ${IPCLUSTER_DIR}/log/ipcluster-*.log
}

experiment() {
  EXPERIMENT_TYPE="$1"
  nohup python "${EXPERIMENT_TYPE}.py" &> ${EXPERIMENT_LOG} &
  echo "${EXPERIMENT_LOG}"
  exit 0
}

mkdir -p ${LOG_DIR}
while :; do
  case "$1" in
    start)
      start "$2"
      ;;
    stop)
      stop
      ;;
    status)
      status
      ;;
    exp|experiment)
      experiment "$2"
      ;;
    *)
      usage
      ;;
  esac
done
shift $((OPTIND-1))



